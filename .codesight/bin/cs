#!/bin/bash
# CodeSight quick launcher

# This is a simplified version focusing on reliability and simplicity

# Find the codesight installation directory
SCRIPT_PATH="$0"
if [[ -n "${BASH_SOURCE[0]}" ]]; then
    # For bash when script is sourced
    SCRIPT_PATH="${BASH_SOURCE[0]}"
fi

# Get absolute path of the script - with fallbacks for symlinks
if command -v realpath &> /dev/null; then
    # Use realpath if available
    SCRIPT_DIR=$(dirname "$(realpath "$SCRIPT_PATH")")
else
    # Manual resolution
    SOURCE="$SCRIPT_PATH"
    while [ -h "$SOURCE" ]; do
        DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
        SOURCE="$(readlink "$SOURCE")"
        [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
    done
    SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
fi

CODESIGHT_DIR="$(dirname "$SCRIPT_DIR")"

# Basic validation
if [ ! -f "$SCRIPT_DIR/cs.py" ]; then
    echo "Error: CodeSight installation is incomplete or corrupted"
    echo "Cannot find cs.py at $SCRIPT_DIR"
    exit 1
fi

# Create and use a virtual environment in the current project
PROJECT_DIR="$(pwd)"
VENV_DIR="$PROJECT_DIR/.venv"

# Handle virtual environment
if [ ! -d "$VENV_DIR" ]; then
    echo "Setting up virtual environment for project at $PROJECT_DIR..."
    
    # Install UV if needed
    if ! command -v uv &> /dev/null; then
        echo "Installing uv..."
        pip install uv
    fi
    
    # Create and activate virtual environment
    uv venv
    source "$VENV_DIR/bin/activate"
    
    # Install dependencies
    echo "Installing dependencies..."
    uv pip install tiktoken openai pytest typer more-itertools humanize pathspec
else
    # Activate existing environment
    source "$VENV_DIR/bin/activate"
fi

# Print debugging info if requested
if [[ "$*" == *"--debug"* ]]; then
    echo "CodeSight Debug Info:"
    echo "  Script directory: $SCRIPT_DIR"
    echo "  CodeSight directory: $CODESIGHT_DIR"
    echo "  Project directory: $PROJECT_DIR"
    echo "  Virtual env: $VENV_DIR"
    echo "  Python script: $SCRIPT_DIR/cs.py"
fi

# Run the CS command
python "$SCRIPT_DIR/cs.py" "$@"